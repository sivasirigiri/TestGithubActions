name: Docker Image CI

on:
  push:
    branches: [ "master", "ghcr_integration"]
  pull_request:
    branches: [ "master" ]

jobs:

  build-and-push:

    runs-on: windows-latest
    permissions:
      contents: read
      packages: write # Required to push images to GHCR

    steps:
    - uses: actions/checkout@v4
    
    - name: Setup MSBuild
      # This action adds MSBuild.exe to the PATH environment variable
      uses: microsoft/setup-msbuild@v2
      
    - name: Restore NuGet packages
      run: nuget restore TestGitHubActions.sln

    - name: Build solution
      # Use msbuild.exe to build the solution in Release configuration
      run: |
        msbuild.exe TestGitHubActions.sln /p:Configuration=Release
    - name: Publish web application
      run: |
        msbuild.exe TestGitHubActions.sln /p:Configuration=Release /p:DeployOnBuild=true /p:PublishProfile="FolderProfile"
      env:
        # Example using a GitHub Secret for a sensitive variable
        FolderProfile: ${{ secrets.PUBLISH_PROFILE_XML }}

    - name: Archive build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-app-release
        path: bin\app.publish\

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
          registry: ghcr.io
          username: ${{ github.actor }} #The github.actor variable in GitHub Actions provides the username of the user or app that initiated the workflow run.
          password: ${{ secrets.REGISTY_PAT }}
    
    - name: Extract Docker image metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
          images: |
            #your-dockerhub-username/your-app
            #ghcr.io/your-github-username/your-app
            ghcr.io/${{ github.repository }}
          tags: |
            type=schedule
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
          labels: |
            org.opencontainers.image.title=${{ github.event.repository.name }}
            org.opencontainers.image.description=This is a test app to validat github acitons

    #- name: Build and push
    #  uses: docker/build-push-action@v6
    #  with:
     #     push: ${{ github.event_name != 'pull_request' }}
     #     tags: ${{ steps.meta.outputs.tags }}
    #      labels: ${{ steps.meta.outputs.labels }}
    #      build-args: |
    #        APP_WKSPC=$${{ github.workspace }}
     #     context: . # Or specify a different build context path
     #     file: ./Dockerfile # Specify the path to your Dockerfile

    - name: Build and Push
      shell: powershell
      env:
         REG_USER_NAME: ${{ github.actor }}  # Assign the secret to an environment variable
         MY_USERNAME: ${{ github.actor }}
         MY_PASSWORD: ${{ secrets.REGISTY_PAT }}
         REP_NAME: ${GITHUB_REPOSITORY#*/}
      run: |
           $username = $env:MY_USERNAME
           $password = $env:MY_PASSWORD
           Write-Host "Registry user name: $env:REG_USER_NAME"
           Write-Host "Repository name: $env:REP_NAME"
           $imageName = "ghcr.io/$env:REG_USER_NAME/$env:REP_NAME:latest"
           Write-Host "Building Docker image: $imageName"
           Write-Host "Github Workspace: ${{ github.workspace }}"
           docker build -t $imageName -f ${{ github.workspace }}/Dockerfile .
           Write-Host "Pushing Docker image: $imageName"
           #docker login ghcr.io -u $username -p $password
           docker push $imageName

    
